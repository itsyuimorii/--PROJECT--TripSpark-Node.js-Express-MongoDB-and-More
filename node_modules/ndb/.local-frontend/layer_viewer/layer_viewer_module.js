self["LayerViewer"]=self["LayerViewer"]||{};LayerViewer.LayerDetailsView=class extends UI.Widget{constructor(e){super(true);this.registerRequiredCSS("layer_viewer/layerDetailsView.css");this._layerViewHost=e;this._layerViewHost.registerView(this);this._emptyWidget=new UI.EmptyWidget(Common.UIString("Select a layer to see its details"));this._buildContent()}hoverObject(e){}selectObject(e){this._selection=e;if(this.isShowing())this.update()}setLayerTree(e){}wasShown(){super.wasShown();this.update()}_onScrollRectClicked(e,t){if(t.which!==1)return;this._layerViewHost.selectObject(new LayerViewer.LayerView.ScrollRectSelection(this._selection.layer(),e))}_onPaintProfilerButtonClicked(){if(this._selection.type()===LayerViewer.LayerView.Selection.Type.Snapshot||this._selection.layer())this.dispatchEventToListeners(LayerViewer.LayerDetailsView.Events.PaintProfilerRequested,this._selection)}_createScrollRectElement(e,t){if(t)this._scrollRectsCell.createTextChild(", ");const i=this._scrollRectsCell.createChild("span","scroll-rect");if(this._selection.scrollRectIndex===t)i.classList.add("active");i.textContent=Common.UIString("%s %d × %d (at %d, %d)",LayerViewer.LayerDetailsView._slowScrollRectNames.get(e.type),e.rect.x,e.rect.y,e.rect.width,e.rect.height);i.addEventListener("click",this._onScrollRectClicked.bind(this,t),false)}_formatStickyAncestorLayer(e,t){if(!t)return"";const i=t.nodeForSelfOrAncestor();const r=i?i.simpleSelector():Common.UIString("<unnamed>");return Common.UIString("%s: %s (%s)",e,r,t.id())}_createStickyAncestorChild(e,t){if(!t)return;this._stickyPositionConstraintCell.createTextChild(", ");const i=this._stickyPositionConstraintCell.createChild("span");i.textContent=this._formatStickyAncestorLayer(e,t)}_populateStickyPositionConstraintCell(e){this._stickyPositionConstraintCell.removeChildren();if(!e)return;const t=e.stickyBoxRect();const i=this._stickyPositionConstraintCell.createChild("span");i.textContent=Common.UIString("Sticky Box %d × %d (at %d, %d)",t.width,t.height,t.x,t.y);this._stickyPositionConstraintCell.createTextChild(", ");const r=e.containingBlockRect();const s=this._stickyPositionConstraintCell.createChild("span");s.textContent=Common.UIString("Containing Block %d × %d (at %d, %d)",r.width,r.height,r.x,r.y);this._createStickyAncestorChild(Common.UIString("Nearest Layer Shifting Sticky Box"),e.nearestLayerShiftingStickyBox());this._createStickyAncestorChild(Common.UIString("Nearest Layer Shifting Containing Block"),e.nearestLayerShiftingContainingBlock())}update(){const e=this._selection&&this._selection.layer();if(!e){this._tableElement.remove();this._paintProfilerButton.remove();this._emptyWidget.show(this.contentElement);return}this._emptyWidget.detach();this.contentElement.appendChild(this._tableElement);this.contentElement.appendChild(this._paintProfilerButton);this._sizeCell.textContent=Common.UIString("%d × %d (at %d,%d)",e.width(),e.height(),e.offsetX(),e.offsetY());this._paintCountCell.parentElement.classList.toggle("hidden",!e.paintCount());this._paintCountCell.textContent=e.paintCount();this._memoryEstimateCell.textContent=Number.bytesToString(e.gpuMemoryUsage());e.requestCompositingReasons().then(this._updateCompositingReasons.bind(this));this._scrollRectsCell.removeChildren();e.scrollRects().forEach(this._createScrollRectElement.bind(this));this._populateStickyPositionConstraintCell(e.stickyPositionConstraint());const t=this._selection.type()===LayerViewer.LayerView.Selection.Type.Snapshot?this._selection.snapshot():null;this._paintProfilerButton.classList.toggle("hidden",!t)}_buildContent(){this._tableElement=this.contentElement.createChild("table");this._tbodyElement=this._tableElement.createChild("tbody");this._sizeCell=this._createRow(Common.UIString("Size"));this._compositingReasonsCell=this._createRow(Common.UIString("Compositing Reasons"));this._memoryEstimateCell=this._createRow(Common.UIString("Memory estimate"));this._paintCountCell=this._createRow(Common.UIString("Paint count"));this._scrollRectsCell=this._createRow(Common.UIString("Slow scroll regions"));this._stickyPositionConstraintCell=this._createRow(Common.UIString("Sticky position constraint"));this._paintProfilerButton=this.contentElement.createChild("a","hidden link");this._paintProfilerButton.textContent=Common.UIString("Paint Profiler");this._paintProfilerButton.addEventListener("click",this._onPaintProfilerButtonClicked.bind(this))}_createRow(e){const t=this._tbodyElement.createChild("tr");const i=t.createChild("td");i.textContent=e;return t.createChild("td")}_updateCompositingReasons(e){if(!e||!e.length){this._compositingReasonsCell.textContent="n/a";return}this._compositingReasonsCell.removeChildren();const t=this._compositingReasonsCell.createChild("ul");for(let i=0;i<e.length;++i){let r=LayerViewer.LayerDetailsView.CompositingReasonDetail[e[i]]||e[i];if(/\s.*[^.]$/.test(r))r+=".";t.createChild("li").textContent=r}}};LayerViewer.LayerDetailsView.Events={PaintProfilerRequested:Symbol("PaintProfilerRequested")};LayerViewer.LayerDetailsView.CompositingReasonDetail={transform3D:Common.UIString("Composition due to association with an element with a CSS 3D transform."),video:Common.UIString("Composition due to association with a <video> element."),canvas:Common.UIString("Composition due to the element being a <canvas> element."),plugin:Common.UIString("Composition due to association with a plugin."),iFrame:Common.UIString("Composition due to association with an <iframe> element."),backfaceVisibilityHidden:Common.UIString('Composition due to association with an element with a "backface-visibility: hidden" style.'),animation:Common.UIString("Composition due to association with an animated element."),filters:Common.UIString("Composition due to association with an element with CSS filters applied."),scrollDependentPosition:Common.UIString('Composition due to association with an element with a "position: fixed" or "position: sticky" style.'),overflowScrollingTouch:Common.UIString('Composition due to association with an element with a "overflow-scrolling: touch" style.'),blending:Common.UIString('Composition due to association with an element that has blend mode other than "normal".'),assumedOverlap:Common.UIString("Composition due to association with an element that may overlap other composited elements."),overlap:Common.UIString("Composition due to association with an element overlapping other composited elements."),negativeZIndexChildren:Common.UIString("Composition due to association with an element with descendants that have a negative z-index."),transformWithCompositedDescendants:Common.UIString("Composition due to association with an element with composited descendants."),opacityWithCompositedDescendants:Common.UIString("Composition due to association with an element with opacity applied and composited descendants."),maskWithCompositedDescendants:Common.UIString("Composition due to association with a masked element and composited descendants."),reflectionWithCompositedDescendants:Common.UIString("Composition due to association with an element with a reflection and composited descendants."),filterWithCompositedDescendants:Common.UIString("Composition due to association with an element with CSS filters applied and composited descendants."),blendingWithCompositedDescendants:Common.UIString("Composition due to association with an element with CSS blending applied and composited descendants."),clipsCompositingDescendants:Common.UIString("Composition due to association with an element clipping compositing descendants."),perspective:Common.UIString("Composition due to association with an element with perspective applied."),preserve3D:Common.UIString('Composition due to association with an element with a "transform-style: preserve-3d" style.'),root:Common.UIString("Root layer."),layerForClip:Common.UIString("Layer for clip."),layerForScrollbar:Common.UIString("Layer for scrollbar."),layerForScrollingContainer:Common.UIString("Layer for scrolling container."),layerForForeground:Common.UIString("Layer for foreground."),layerForBackground:Common.UIString("Layer for background."),layerForMask:Common.UIString("Layer for mask."),layerForVideoOverlay:Common.UIString("Layer for video overlay.")};LayerViewer.LayerDetailsView._slowScrollRectNames=new Map([[SDK.Layer.ScrollRectType.NonFastScrollable,Common.UIString("Non fast scrollable")],[SDK.Layer.ScrollRectType.TouchEventHandler,Common.UIString("Touch event handler")],[SDK.Layer.ScrollRectType.WheelEventHandler,Common.UIString("Wheel event handler")],[SDK.Layer.ScrollRectType.RepaintsOnScroll,Common.UIString("Repaints on scroll")]]);LayerViewer.LayerTreeOutline=class extends Common.Object{constructor(e){super();this._layerViewHost=e;this._layerViewHost.registerView(this);this._treeOutline=new UI.TreeOutlineInShadow;this._treeOutline.element.classList.add("layer-tree","overflow-auto");this._treeOutline.element.addEventListener("mousemove",this._onMouseMove.bind(this),false);this._treeOutline.element.addEventListener("mouseout",this._onMouseMove.bind(this),false);this._treeOutline.element.addEventListener("contextmenu",this._onContextMenu.bind(this),true);this._lastHoveredNode=null;this.element=this._treeOutline.element;this._layerViewHost.showInternalLayersSetting().addChangeListener(this._update,this)}focus(){this._treeOutline.focus()}selectObject(e){this.hoverObject(null);const t=e&&e.layer();const i=t&&t[LayerViewer.LayerTreeElement._symbol];if(i)i.revealAndSelect(true);else if(this._treeOutline.selectedTreeElement)this._treeOutline.selectedTreeElement.deselect()}hoverObject(e){const t=e&&e.layer();const i=t&&t[LayerViewer.LayerTreeElement._symbol];if(i===this._lastHoveredNode)return;if(this._lastHoveredNode)this._lastHoveredNode.setHovered(false);if(i)i.setHovered(true);this._lastHoveredNode=i}setLayerTree(e){this._layerTree=e;this._update()}_update(){const e=this._layerViewHost.showInternalLayersSetting().get();const t=new Map;let i=null;if(this._layerTree){if(!e)i=this._layerTree.contentRoot();if(!i)i=this._layerTree.root()}function r(r){if(!r.drawsContent()&&!e)return;if(t.get(r))console.assert(false,"Duplicate layer: "+r.id());t.set(r,true);let s=r[LayerViewer.LayerTreeElement._symbol];let o=r.parent();while(o&&o!==i&&!o.drawsContent()&&!e)o=o.parent();const n=r===i?this._treeOutline.rootElement():o[LayerViewer.LayerTreeElement._symbol];if(!n){console.assert(false,"Parent is not in the tree");return}if(!s){s=new LayerViewer.LayerTreeElement(this,r);n.appendChild(s);if(!r.drawsContent())s.expand()}else{if(s.parent!==n){const e=this._treeOutline.selectedTreeElement;if(s.parent)s.parent.removeChild(s);n.appendChild(s);if(e!==this._treeOutline.selectedTreeElement)e.select()}s._update()}}if(i)this._layerTree.forEachLayer(r.bind(this),i);const s=this._treeOutline.rootElement();for(let e=s.firstChild();e&&!e.root;){if(t.get(e._layer)){e=e.traverseNextTreeElement(false)}else{const t=e.nextSibling||e.parent;e.parent.removeChild(e);if(e===this._lastHoveredNode)this._lastHoveredNode=null;e=t}}if(!this._treeOutline.selectedTreeElement){const e=this._layerTree.contentRoot()||this._layerTree.root();if(e)e[LayerViewer.LayerTreeElement._symbol].revealAndSelect(true)}}_onMouseMove(e){const t=this._treeOutline.treeElementFromEvent(e);if(t===this._lastHoveredNode)return;this._layerViewHost.hoverObject(this._selectionForNode(t))}_selectedNodeChanged(e){this._layerViewHost.selectObject(this._selectionForNode(e))}_onContextMenu(e){const t=this._selectionForNode(this._treeOutline.treeElementFromEvent(e));const i=new UI.ContextMenu(e);this._layerViewHost.showContextMenu(i,t)}_selectionForNode(e){return e&&e._layer?new LayerViewer.LayerView.LayerSelection(e._layer):null}};LayerViewer.LayerTreeElement=class extends UI.TreeElement{constructor(e,t){super();this._treeOutline=e;this._layer=t;this._layer[LayerViewer.LayerTreeElement._symbol]=this;this._update()}_update(){const e=this._layer.nodeForSelfOrAncestor();const t=createDocumentFragment();t.createTextChild(e?e.simpleSelector():"#"+this._layer.id());const i=t.createChild("span","dimmed");i.textContent=Common.UIString(" (%d × %d)",this._layer.width(),this._layer.height());this.title=t}onselect(){this._treeOutline._selectedNodeChanged(this);return false}setHovered(e){this.listItemElement.classList.toggle("hovered",e)}};LayerViewer.LayerTreeElement._symbol=Symbol("layer");LayerViewer.LayerView=function(){};LayerViewer.LayerView.prototype={hoverObject(e){},selectObject(e){},setLayerTree(e){}};LayerViewer.LayerView.Selection=class{constructor(e,t){this._type=e;this._layer=t}static isEqual(e,t){return e&&t?e._isEqual(t):e===t}type(){return this._type}layer(){return this._layer}_isEqual(e){return false}};LayerViewer.LayerView.Selection.Type={Layer:Symbol("Layer"),ScrollRect:Symbol("ScrollRect"),Snapshot:Symbol("Snapshot")};LayerViewer.LayerView.LayerSelection=class extends LayerViewer.LayerView.Selection{constructor(e){console.assert(e,"LayerSelection with empty layer");super(LayerViewer.LayerView.Selection.Type.Layer,e)}_isEqual(e){return e._type===LayerViewer.LayerView.Selection.Type.Layer&&e.layer().id()===this.layer().id()}};LayerViewer.LayerView.ScrollRectSelection=class extends LayerViewer.LayerView.Selection{constructor(e,t){super(LayerViewer.LayerView.Selection.Type.ScrollRect,e);this.scrollRectIndex=t}_isEqual(e){return e._type===LayerViewer.LayerView.Selection.Type.ScrollRect&&this.layer().id()===e.layer().id()&&this.scrollRectIndex===e.scrollRectIndex}};LayerViewer.LayerView.SnapshotSelection=class extends LayerViewer.LayerView.Selection{constructor(e,t){super(LayerViewer.LayerView.Selection.Type.Snapshot,e);this._snapshot=t}_isEqual(e){return e._type===LayerViewer.LayerView.Selection.Type.Snapshot&&this.layer().id()===e.layer().id()&&this._snapshot===e._snapshot}snapshot(){return this._snapshot}};LayerViewer.LayerViewHost=class{constructor(){this._views=[];this._selectedObject=null;this._hoveredObject=null;this._showInternalLayersSetting=Common.settings.createSetting("layersShowInternalLayers",false)}registerView(e){this._views.push(e)}setLayerTree(e){this._target=e.target();const t=this._selectedObject&&this._selectedObject.layer();if(t&&(!e||!e.layerById(t.id())))this.selectObject(null);const i=this._hoveredObject&&this._hoveredObject.layer();if(i&&(!e||!e.layerById(i.id())))this.hoverObject(null);for(const t of this._views)t.setLayerTree(e)}hoverObject(e){if(LayerViewer.LayerView.Selection.isEqual(this._hoveredObject,e))return;this._hoveredObject=e;const t=e&&e.layer();this._toggleNodeHighlight(t?t.nodeForSelfOrAncestor():null);for(const t of this._views)t.hoverObject(e)}selectObject(e){if(LayerViewer.LayerView.Selection.isEqual(this._selectedObject,e))return;this._selectedObject=e;for(const t of this._views)t.selectObject(e)}selection(){return this._selectedObject}showContextMenu(e,t){e.defaultSection().appendCheckboxItem(Common.UIString("Show internal layers"),this._toggleShowInternalLayers.bind(this),this._showInternalLayersSetting.get());const i=t&&t.layer()&&t.layer().nodeForSelfOrAncestor();if(i)e.appendApplicableItems(i);e.show()}showInternalLayersSetting(){return this._showInternalLayersSetting}_toggleShowInternalLayers(){this._showInternalLayersSetting.set(!this._showInternalLayersSetting.get())}_toggleNodeHighlight(e){if(e){e.highlightForTwoSeconds();return}SDK.OverlayModel.hideDOMNodeHighlight()}};LayerViewer.Layers3DView=class extends UI.VBox{constructor(e){super(true);this.registerRequiredCSS("layer_viewer/layers3DView.css");this.contentElement.classList.add("layers-3d-view");this._failBanner=new UI.VBox;this._failBanner.element.classList.add("full-widget-dimmed-banner");this._failBanner.element.createTextChild(Common.UIString("Layer information is not yet available."));this._layerViewHost=e;this._layerViewHost.registerView(this);this._transformController=new LayerViewer.TransformController(this.contentElement);this._transformController.addEventListener(LayerViewer.TransformController.Events.TransformChanged,this._update,this);this._initToolbar();this._canvasElement=this.contentElement.createChild("canvas");this._canvasElement.tabIndex=0;this._canvasElement.addEventListener("dblclick",this._onDoubleClick.bind(this),false);this._canvasElement.addEventListener("mousedown",this._onMouseDown.bind(this),false);this._canvasElement.addEventListener("mouseup",this._onMouseUp.bind(this),false);this._canvasElement.addEventListener("mouseleave",this._onMouseMove.bind(this),false);this._canvasElement.addEventListener("mousemove",this._onMouseMove.bind(this),false);this._canvasElement.addEventListener("contextmenu",this._onContextMenu.bind(this),false);this._lastSelection={};this._layerTree=null;this._textureManager=new LayerViewer.LayerTextureManager(this._update.bind(this));this._chromeTextures=[];this._rects=[];this._layerViewHost.showInternalLayersSetting().addChangeListener(this._update,this)}setLayerTree(e){this._layerTree=e;this._layerTexture=null;delete this._oldTextureScale;if(this._showPaints())this._textureManager.setLayerTree(e);this._update()}showImageForLayer(e,t){if(!t){this._layerTexture=null;this._update();return}UI.loadImage(t).then(t=>{const i=t&&LayerViewer.LayerTextureManager._createTextureForImage(this._gl,t);this._layerTexture=i?{layer:e,texture:i}:null;this._update()})}onResize(){this._resizeCanvas();this._update()}willHide(){this._textureManager.suspend()}wasShown(){this._textureManager.resume();if(!this._needsUpdate)return;this._resizeCanvas();this._update()}updateLayerSnapshot(e){this._textureManager.layerNeedsUpdate(e)}_setOutline(e,t){this._lastSelection[e]=t;this._update()}hoverObject(e){this._setOutline(LayerViewer.Layers3DView.OutlineType.Hovered,e)}selectObject(e){this._setOutline(LayerViewer.Layers3DView.OutlineType.Hovered,null);this._setOutline(LayerViewer.Layers3DView.OutlineType.Selected,e)}snapshotForSelection(e){if(e.type()===LayerViewer.LayerView.Selection.Type.Snapshot){const t=e.snapshot();t.snapshot.addReference();return Promise.resolve(t)}if(e.layer()){const t=e.layer().snapshots()[0];if(t)return t}return Promise.resolve(null)}_initGL(e){const t=e.getContext("webgl");if(!t)return null;t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);t.enable(t.BLEND);t.clearColor(0,0,0,0);t.enable(t.DEPTH_TEST);return t}_createShader(e,t){const i=this._gl.createShader(e);this._gl.shaderSource(i,t);this._gl.compileShader(i);this._gl.attachShader(this._shaderProgram,i)}_initShaders(){this._shaderProgram=this._gl.createProgram();this._createShader(this._gl.FRAGMENT_SHADER,LayerViewer.Layers3DView.FragmentShader);this._createShader(this._gl.VERTEX_SHADER,LayerViewer.Layers3DView.VertexShader);this._gl.linkProgram(this._shaderProgram);this._gl.useProgram(this._shaderProgram);this._shaderProgram.vertexPositionAttribute=this._gl.getAttribLocation(this._shaderProgram,"aVertexPosition");this._gl.enableVertexAttribArray(this._shaderProgram.vertexPositionAttribute);this._shaderProgram.vertexColorAttribute=this._gl.getAttribLocation(this._shaderProgram,"aVertexColor");this._gl.enableVertexAttribArray(this._shaderProgram.vertexColorAttribute);this._shaderProgram.textureCoordAttribute=this._gl.getAttribLocation(this._shaderProgram,"aTextureCoord");this._gl.enableVertexAttribArray(this._shaderProgram.textureCoordAttribute);this._shaderProgram.pMatrixUniform=this._gl.getUniformLocation(this._shaderProgram,"uPMatrix");this._shaderProgram.samplerUniform=this._gl.getUniformLocation(this._shaderProgram,"uSampler")}_resizeCanvas(){this._canvasElement.width=this._canvasElement.offsetWidth*window.devicePixelRatio;this._canvasElement.height=this._canvasElement.offsetHeight*window.devicePixelRatio}_updateTransformAndConstraints(){const e=.1;const t=this._layerTree.viewportSize();const i=t?t.width:this._dimensionsForAutoscale.width;const r=t?t.height:this._dimensionsForAutoscale.height;const s=this._canvasElement.width;const o=this._canvasElement.height;const n=s*e;const a=o*e;const l=(s-2*n)/i;const h=(o-2*a)/r;const c=Math.min(l,h);const d=Math.min(i/this._dimensionsForAutoscale.width,r/this._dimensionsForAutoscale.width)/2;this._transformController.setScaleConstraints(d,10/c);const _=this._transformController.scale();const m=this._transformController.rotateX();const u=this._transformController.rotateY();this._scale=_*c;const y=Number.constrain(this._scale,.1,1);if(y!==this._oldTextureScale){this._oldTextureScale=y;this._textureManager.setScale(y);this.dispatchEventToListeners(LayerViewer.Layers3DView.Events.ScaleChanged,y)}const w=(new WebKitCSSMatrix).scale(_,_,_).translate(s/2,o/2,0).rotate(m,u,0).scale(c,c,c).translate(-i/2,-r/2,0);let g;for(let e=0;e<this._rects.length;++e)g=UI.Geometry.boundsForTransformedPoints(w,this._rects[e].vertices,g);this._transformController.clampOffsets((n-g.maxX)/window.devicePixelRatio,(s-n-g.minX)/window.devicePixelRatio,(a-g.maxY)/window.devicePixelRatio,(o-a-g.minY)/window.devicePixelRatio);const p=this._transformController.offsetX()*window.devicePixelRatio;const f=this._transformController.offsetY()*window.devicePixelRatio;this._projectionMatrix=(new WebKitCSSMatrix).translate(p,f,0).multiply(w);const L=(new WebKitCSSMatrix).scale(1,-1,-1).translate(-1,-1,0).scale(2/this._canvasElement.width,2/this._canvasElement.height,1/1e6).multiply(this._projectionMatrix);this._gl.uniformMatrix4fv(this._shaderProgram.pMatrixUniform,false,this._arrayFromMatrix(L))}_arrayFromMatrix(e){return new Float32Array([e.m11,e.m12,e.m13,e.m14,e.m21,e.m22,e.m23,e.m24,e.m31,e.m32,e.m33,e.m34,e.m41,e.m42,e.m43,e.m44])}_initWhiteTexture(){this._whiteTexture=this._gl.createTexture();this._gl.bindTexture(this._gl.TEXTURE_2D,this._whiteTexture);const e=new Uint8Array([255,255,255,255]);this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,1,1,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e)}_initChromeTextures(){function e(e,t){UI.loadImage(t).then(t=>{this._chromeTextures[e]=t&&LayerViewer.LayerTextureManager._createTextureForImage(this._gl,t)||undefined})}e.call(this,LayerViewer.Layers3DView.ChromeTexture.Left,"Images/chromeLeft.png");e.call(this,LayerViewer.Layers3DView.ChromeTexture.Middle,"Images/chromeMiddle.png");e.call(this,LayerViewer.Layers3DView.ChromeTexture.Right,"Images/chromeRight.png")}_initGLIfNecessary(){if(this._gl)return this._gl;this._gl=this._initGL(this._canvasElement);if(!this._gl)return null;this._initShaders();this._initWhiteTexture();this._initChromeTextures();this._textureManager.setContext(this._gl);return this._gl}_calculateDepthsAndVisibility(){this._depthByLayerId={};let e=0;const t=this._layerViewHost.showInternalLayersSetting().get();const i=t?this._layerTree.root():this._layerTree.contentRoot()||this._layerTree.root();const r=[i];this._depthByLayerId[i.id()]=0;this._visibleLayers=new Set;while(r.length>0){const i=r.shift();if(t||i.drawsContent())this._visibleLayers.add(i);const s=i.children();for(let t=0;t<s.length;++t){this._depthByLayerId[s[t].id()]=++e;r.push(s[t])}}this._maxDepth=e}_depthForLayer(e){return this._depthByLayerId[e.id()]*LayerViewer.Layers3DView.LayerSpacing}_calculateScrollRectDepth(e,t){return this._depthForLayer(e)+t*LayerViewer.Layers3DView.ScrollRectSpacing+1}_updateDimensionsForAutoscale(e){this._dimensionsForAutoscale.width=Math.max(e.width(),this._dimensionsForAutoscale.width);this._dimensionsForAutoscale.height=Math.max(e.height(),this._dimensionsForAutoscale.height)}_calculateLayerRect(e){if(!this._visibleLayers.has(e))return;const t=new LayerViewer.LayerView.LayerSelection(e);const i=new LayerViewer.Layers3DView.Rectangle(t);i.setVertices(e.quad(),this._depthForLayer(e));this._appendRect(i);this._updateDimensionsForAutoscale(e)}_appendRect(e){const t=e.relatedObject;const i=LayerViewer.LayerView.Selection.isEqual(this._lastSelection[LayerViewer.Layers3DView.OutlineType.Selected],t);const r=LayerViewer.LayerView.Selection.isEqual(this._lastSelection[LayerViewer.Layers3DView.OutlineType.Hovered],t);if(i){e.borderColor=LayerViewer.Layers3DView.SelectedBorderColor}else if(r){e.borderColor=LayerViewer.Layers3DView.HoveredBorderColor;const t=e.fillColor||[255,255,255,1];const i=LayerViewer.Layers3DView.HoveredImageMaskColor;e.fillColor=[t[0]*i[0]/255,t[1]*i[1]/255,t[2]*i[2]/255,t[3]*i[3]]}else{e.borderColor=LayerViewer.Layers3DView.BorderColor}e.lineWidth=i?LayerViewer.Layers3DView.SelectedBorderWidth:LayerViewer.Layers3DView.BorderWidth;this._rects.push(e)}_calculateLayerScrollRects(e){const t=e.scrollRects();for(let i=0;i<t.length;++i){const r=new LayerViewer.LayerView.ScrollRectSelection(e,i);const s=new LayerViewer.Layers3DView.Rectangle(r);s.calculateVerticesFromRect(e,t[i].rect,this._calculateScrollRectDepth(e,i));s.fillColor=LayerViewer.Layers3DView.ScrollRectBackgroundColor;this._appendRect(s)}}_calculateLayerTileRects(e){const t=this._textureManager.tilesForLayer(e);for(let i=0;i<t.length;++i){const r=t[i];if(!r.texture)continue;const s=new LayerViewer.LayerView.SnapshotSelection(e,{rect:r.rect,snapshot:r.snapshot});const o=new LayerViewer.Layers3DView.Rectangle(s);o.calculateVerticesFromRect(e,r.rect,this._depthForLayer(e)+1);o.texture=r.texture;this._appendRect(o)}}_calculateRects(){this._rects=[];this._dimensionsForAutoscale={width:0,height:0};this._layerTree.forEachLayer(this._calculateLayerRect.bind(this));if(this._showSlowScrollRectsSetting.get())this._layerTree.forEachLayer(this._calculateLayerScrollRects.bind(this));if(this._layerTexture&&this._visibleLayers.has(this._layerTexture.layer)){const e=this._layerTexture.layer;const t=new LayerViewer.LayerView.LayerSelection(e);const i=new LayerViewer.Layers3DView.Rectangle(t);i.setVertices(e.quad(),this._depthForLayer(e));i.texture=this._layerTexture.texture;this._appendRect(i)}else if(this._showPaints()){this._layerTree.forEachLayer(this._calculateLayerTileRects.bind(this))}}_makeColorsArray(e){let t=[];const i=[e[0]/255,e[1]/255,e[2]/255,e[3]];for(let e=0;e<4;e++)t=t.concat(i);return t}_setVertexAttribute(e,t,i){const r=this._gl;const s=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,s);r.bufferData(r.ARRAY_BUFFER,new Float32Array(t),r.STATIC_DRAW);r.vertexAttribPointer(e,i,r.FLOAT,false,0,0)}_drawRectangle(e,t,i,r){const s=this._gl;const o=[255,255,255,1];i=i||o;this._setVertexAttribute(this._shaderProgram.vertexPositionAttribute,e,3);this._setVertexAttribute(this._shaderProgram.textureCoordAttribute,[0,1,1,1,1,0,0,0],2);this._setVertexAttribute(this._shaderProgram.vertexColorAttribute,this._makeColorsArray(i),i.length);if(r){s.activeTexture(s.TEXTURE0);s.bindTexture(s.TEXTURE_2D,r);s.uniform1i(this._shaderProgram.samplerUniform,0)}else{s.bindTexture(s.TEXTURE_2D,this._whiteTexture)}const n=e.length/3;s.drawArrays(t,0,n)}_drawTexture(e,t,i){this._drawRectangle(e,this._gl.TRIANGLE_FAN,i,t)}_drawViewportAndChrome(){const e=this._layerTree.viewportSize();if(!e)return;const t=!Common.moduleSetting("frameViewerHideChromeWindow").get()&&this._chromeTextures.length>=3&&this._chromeTextures.indexOf(undefined)<0;const i=(this._maxDepth+1)*LayerViewer.Layers3DView.LayerSpacing;const r=Math.ceil(LayerViewer.Layers3DView.ViewportBorderWidth*this._scale);let s=[e.width,0,i,e.width,e.height,i,0,e.height,i,0,0,i];this._gl.lineWidth(r);this._drawRectangle(s,t?this._gl.LINE_STRIP:this._gl.LINE_LOOP,LayerViewer.Layers3DView.ViewportBorderColor);if(!t)return;const o=LayerViewer.Layers3DView.ViewportBorderWidth/2;const n=this._layerTree.viewportSize().width+2*o;const a=this._chromeTextures[0].image.naturalHeight;const l=n-this._chromeTextures[0].image.naturalWidth-this._chromeTextures[2].image.naturalWidth;let h=-o;const c=-a;for(let e=0;e<this._chromeTextures.length;++e){const t=e===LayerViewer.Layers3DView.ChromeTexture.Middle?l:this._chromeTextures[e].image.naturalWidth;if(t<0||h+t>n)break;s=[h,c,i,h+t,c,i,h+t,c+a,i,h,c+a,i];this._drawTexture(s,this._chromeTextures[e]);h+=t}}_drawViewRect(e){const t=e.vertices;if(e.texture)this._drawTexture(t,e.texture,e.fillColor||undefined);else if(e.fillColor)this._drawRectangle(t,this._gl.TRIANGLE_FAN,e.fillColor);this._gl.lineWidth(e.lineWidth);if(e.borderColor)this._drawRectangle(t,this._gl.LINE_LOOP,e.borderColor)}_update(){if(!this.isShowing()){this._needsUpdate=true;return}if(!this._layerTree||!this._layerTree.root()){this._failBanner.show(this.contentElement);return}const e=this._initGLIfNecessary();if(!e){this._failBanner.element.removeChildren();this._failBanner.element.appendChild(this._webglDisabledBanner());this._failBanner.show(this.contentElement);return}this._failBanner.detach();this._gl.viewportWidth=this._canvasElement.width;this._gl.viewportHeight=this._canvasElement.height;this._calculateDepthsAndVisibility();this._calculateRects();this._updateTransformAndConstraints();e.viewport(0,0,e.viewportWidth,e.viewportHeight);e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);this._rects.forEach(this._drawViewRect.bind(this));this._drawViewportAndChrome()}_webglDisabledBanner(){const e=this.contentElement.ownerDocument.createDocumentFragment();e.createChild("div").textContent=Common.UIString("Can't display layers,");e.createChild("div").textContent=Common.UIString("WebGL support is disabled in your browser.");e.appendChild(UI.formatLocalized("Check %s for possible reasons.",[UI.XLink.create("about:gpu")]));return e}_selectionFromEventPoint(e){if(!this._layerTree)return null;let t=Infinity;let i=null;const r=(new WebKitCSSMatrix).scale(1,-1,-1).translate(-1,-1,0).multiply(this._projectionMatrix);const s=(e.clientX-this._canvasElement.totalOffsetLeft())*window.devicePixelRatio;const o=-(e.clientY-this._canvasElement.totalOffsetTop())*window.devicePixelRatio;function n(e){if(!e.relatedObject)return;const n=e.intersectWithLine(r,s,o);if(n<t){t=n;i=e.relatedObject}}this._rects.forEach(n);return i}_createVisibilitySetting(e,t,i,r){const s=Common.settings.createSetting(t,i);s.setTitle(Common.UIString(e));s.addChangeListener(this._update,this);r.appendToolbarItem(new UI.ToolbarSettingCheckbox(s));return s}_initToolbar(){this._panelToolbar=this._transformController.toolbar();this.contentElement.appendChild(this._panelToolbar.element);this._showSlowScrollRectsSetting=this._createVisibilitySetting("Slow scroll rects","frameViewerShowSlowScrollRects",true,this._panelToolbar);this._showPaintsSetting=this._createVisibilitySetting("Paints","frameViewerShowPaints",true,this._panelToolbar);this._showPaintsSetting.addChangeListener(this._updatePaints,this);Common.moduleSetting("frameViewerHideChromeWindow").addChangeListener(this._update,this)}_onContextMenu(e){const t=new UI.ContextMenu(e);t.defaultSection().appendItem(Common.UIString("Reset View"),this._transformController.resetAndNotify.bind(this._transformController),false);const i=this._selectionFromEventPoint(e);if(i&&i.type()===LayerViewer.LayerView.Selection.Type.Snapshot){t.defaultSection().appendItem(Common.UIString("Show Paint Profiler"),this.dispatchEventToListeners.bind(this,LayerViewer.Layers3DView.Events.PaintProfilerRequested,i),false)}this._layerViewHost.showContextMenu(t,i)}_onMouseMove(e){if(e.which)return;this._layerViewHost.hoverObject(this._selectionFromEventPoint(e))}_onMouseDown(e){this._mouseDownX=e.clientX;this._mouseDownY=e.clientY}_onMouseUp(e){const t=6;if(this._mouseDownX&&Math.abs(e.clientX-this._mouseDownX)<t&&Math.abs(e.clientY-this._mouseDownY)<t)this._layerViewHost.selectObject(this._selectionFromEventPoint(e));delete this._mouseDownX;delete this._mouseDownY}_onDoubleClick(e){const t=this._selectionFromEventPoint(e);if(t&&(t.type()===LayerViewer.LayerView.Selection.Type.Snapshot||t.layer()))this.dispatchEventToListeners(LayerViewer.Layers3DView.Events.PaintProfilerRequested,t);e.stopPropagation()}_updatePaints(){if(this._showPaints()){this._textureManager.setLayerTree(this._layerTree);this._textureManager.forceUpdate()}else{this._textureManager.reset()}this._update()}_showPaints(){return this._showPaintsSetting.get()}};LayerViewer.Layers3DView.LayerStyle;LayerViewer.Layers3DView.OutlineType={Hovered:"hovered",Selected:"selected"};LayerViewer.Layers3DView.Events={PaintProfilerRequested:Symbol("PaintProfilerRequested"),ScaleChanged:Symbol("ScaleChanged")};LayerViewer.Layers3DView.ChromeTexture={Left:0,Middle:1,Right:2};LayerViewer.Layers3DView.ScrollRectTitles={RepaintsOnScroll:Common.UIString("repaints on scroll"),TouchEventHandler:Common.UIString("touch event listener"),WheelEventHandler:Common.UIString("mousewheel event listener")};LayerViewer.Layers3DView.FragmentShader=""+"precision mediump float;\n"+"varying vec4 vColor;\n"+"varying vec2 vTextureCoord;\n"+"uniform sampler2D uSampler;\n"+"void main(void)\n"+"{\n"+"    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t)) * vColor;\n"+"}";LayerViewer.Layers3DView.VertexShader=""+"attribute vec3 aVertexPosition;\n"+"attribute vec2 aTextureCoord;\n"+"attribute vec4 aVertexColor;\n"+"uniform mat4 uPMatrix;\n"+"varying vec2 vTextureCoord;\n"+"varying vec4 vColor;\n"+"void main(void)\n"+"{\n"+"gl_Position = uPMatrix * vec4(aVertexPosition, 1.0);\n"+"vColor = aVertexColor;\n"+"vTextureCoord = aTextureCoord;\n"+"}";LayerViewer.Layers3DView.HoveredBorderColor=[0,0,255,1];LayerViewer.Layers3DView.SelectedBorderColor=[0,255,0,1];LayerViewer.Layers3DView.BorderColor=[0,0,0,1];LayerViewer.Layers3DView.ViewportBorderColor=[160,160,160,1];LayerViewer.Layers3DView.ScrollRectBackgroundColor=[178,100,100,.6];LayerViewer.Layers3DView.HoveredImageMaskColor=[200,200,255,1];LayerViewer.Layers3DView.BorderWidth=1;LayerViewer.Layers3DView.SelectedBorderWidth=2;LayerViewer.Layers3DView.ViewportBorderWidth=3;LayerViewer.Layers3DView.LayerSpacing=20;LayerViewer.Layers3DView.ScrollRectSpacing=4;LayerViewer.LayerTextureManager=class{constructor(e){this._textureUpdatedCallback=e;this._throttler=new Common.Throttler(0);this._scale=0;this._active=false;this.reset()}static _createTextureForImage(e,t){const i=e.createTexture();i.image=t;e.bindTexture(e.TEXTURE_2D,i);e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1);e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i.image);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.bindTexture(e.TEXTURE_2D,null);return i}reset(){if(this._tilesByLayer)this.setLayerTree(null);this._tilesByLayer=new Map;this._queue=[]}setContext(e){this._gl=e;if(this._scale)this._updateTextures()}suspend(){this._active=false}resume(){this._active=true;if(this._queue.length)this._update()}setLayerTree(e){const t=new Set;const i=Array.from(this._tilesByLayer.keys());if(e){e.forEachLayer(e=>{if(!e.drawsContent())return;t.add(e);if(!this._tilesByLayer.has(e)){this._tilesByLayer.set(e,[]);this.layerNeedsUpdate(e)}})}if(!i.length)this.forceUpdate();for(const e of i){if(t.has(e))continue;this._tilesByLayer.get(e).forEach(e=>e.dispose());this._tilesByLayer.delete(e)}}_setSnapshotsForLayer(e,t){const i=new Map((this._tilesByLayer.get(e)||[]).map(e=>[e.snapshot,e]));const r=[];const s=[];for(const e of t){const t=i.get(e);if(t){s.push(t);i.delete(t)}else{r.push(new LayerViewer.LayerTextureManager.Tile(e))}}this._tilesByLayer.set(e,s.concat(r));for(const e of i.values())e.dispose();if(!this._gl||!this._scale)return Promise.resolve();return Promise.all(r.map(e=>e.update(this._gl,this._scale))).then(this._textureUpdatedCallback)}setScale(e){if(this._scale&&this._scale>=e)return;this._scale=e;this._updateTextures()}tilesForLayer(e){return this._tilesByLayer.get(e)||[]}layerNeedsUpdate(e){if(this._queue.indexOf(e)<0)this._queue.push(e);if(this._active)this._throttler.schedule(this._update.bind(this))}forceUpdate(){this._queue.forEach(e=>this._updateLayer(e));this._queue=[];this._update()}_update(){const e=this._queue.shift();if(!e)return Promise.resolve();if(this._queue.length)this._throttler.schedule(this._update.bind(this));return this._updateLayer(e)}_updateLayer(e){return Promise.all(e.snapshots()).then(t=>this._setSnapshotsForLayer(e,t.filter(e=>!!e)))}_updateTextures(){if(!this._gl)return;if(!this._scale)return;for(const e of this._tilesByLayer.values()){for(const t of e){const e=t.updateScale(this._gl,this._scale);if(e)e.then(this._textureUpdatedCallback)}}}};LayerViewer.Layers3DView.Rectangle=class{constructor(e){this.relatedObject=e;this.lineWidth=1;this.borderColor=null;this.fillColor=null;this.texture=null}setVertices(e,t){this.vertices=[e[0],e[1],t,e[2],e[3],t,e[4],e[5],t,e[6],e[7],t]}_calculatePointOnQuad(e,t,i){const r=e[0];const s=e[1];const o=e[2];const n=e[3];const a=e[4];const l=e[5];const h=e[6];const c=e[7];const d=r+t*(o-r);const _=s+t*(n-s);const m=h+t*(a-h);const u=c+t*(l-c);const y=d+i*(m-d);const w=_+i*(u-_);return[y,w]}calculateVerticesFromRect(e,t,i){const r=e.quad();const s=t.x/e.width();const o=(t.x+t.width)/e.width();const n=t.y/e.height();const a=(t.y+t.height)/e.height();const l=this._calculatePointOnQuad(r,s,n).concat(this._calculatePointOnQuad(r,o,n)).concat(this._calculatePointOnQuad(r,o,a)).concat(this._calculatePointOnQuad(r,s,a));this.setVertices(l,i)}intersectWithLine(e,t,i){let r;const s=[];for(r=0;r<4;++r){s[r]=UI.Geometry.multiplyVectorByMatrixAndNormalize(new UI.Geometry.Vector(this.vertices[r*3],this.vertices[r*3+1],this.vertices[r*3+2]),e)}const o=UI.Geometry.crossProduct(UI.Geometry.subtract(s[1],s[0]),UI.Geometry.subtract(s[2],s[1]));const n=o.x;const a=o.y;const l=o.z;const h=-(n*s[0].x+a*s[0].y+l*s[0].z);const c=-(h+n*t+a*i)/l;const d=new UI.Geometry.Vector(t,i,c);const _=s.map(UI.Geometry.subtract.bind(null,d));for(r=0;r<_.length;++r){const e=UI.Geometry.scalarProduct(o,UI.Geometry.crossProduct(_[r],_[(r+1)%_.length]));if(e<0)return undefined}return c}};LayerViewer.LayerTextureManager.Tile=class{constructor(e){this.snapshot=e.snapshot;this.rect=e.rect;this.scale=0;this.texture=null}dispose(){this.snapshot.release();if(this.texture){this._gl.deleteTexture(this.texture);this.texture=null}}updateScale(e,t){if(this.texture&&this.scale>=t)return null;return this.update(e,t)}async update(e,t){this._gl=e;this.scale=t;const i=await this.snapshot.replay(t);const r=i&&await UI.loadImage(i);this.texture=r&&LayerViewer.LayerTextureManager._createTextureForImage(e,r)}};LayerViewer.PaintProfilerView=class extends UI.HBox{constructor(e){super(true);this.registerRequiredCSS("layer_viewer/paintProfiler.css");this.contentElement.classList.add("paint-profiler-overview");this._canvasContainer=this.contentElement.createChild("div","paint-profiler-canvas-container");this._progressBanner=this.contentElement.createChild("div","full-widget-dimmed-banner hidden");this._progressBanner.textContent=Common.UIString("Profiling…");this._pieChart=new PerfUI.PieChart({chartName:ls`Profiling Results`,size:55,formatter:this._formatPieChartTime.bind(this)});this._pieChart.element.classList.add("paint-profiler-pie-chart");this.contentElement.appendChild(this._pieChart.element);this._showImageCallback=e;this._canvas=this._canvasContainer.createChild("canvas","fill");this._context=this._canvas.getContext("2d");this._selectionWindow=new PerfUI.OverviewGrid.Window(this._canvasContainer);this._selectionWindow.addEventListener(PerfUI.OverviewGrid.Events.WindowChanged,this._onWindowChanged,this);this._innerBarWidth=4*window.devicePixelRatio;this._minBarHeight=window.devicePixelRatio;this._barPaddingWidth=2*window.devicePixelRatio;this._outerBarWidth=this._innerBarWidth+this._barPaddingWidth;this._pendingScale=1;this._scale=this._pendingScale;this._reset()}static categories(){if(LayerViewer.PaintProfilerView._categories)return LayerViewer.PaintProfilerView._categories;LayerViewer.PaintProfilerView._categories={shapes:new LayerViewer.PaintProfilerCategory("shapes",Common.UIString("Shapes"),"rgb(255, 161, 129)"),bitmap:new LayerViewer.PaintProfilerCategory("bitmap",Common.UIString("Bitmap"),"rgb(136, 196, 255)"),text:new LayerViewer.PaintProfilerCategory("text",Common.UIString("Text"),"rgb(180, 255, 137)"),misc:new LayerViewer.PaintProfilerCategory("misc",Common.UIString("Misc"),"rgb(206, 160, 255)")};return LayerViewer.PaintProfilerView._categories}static _initLogItemCategories(){if(LayerViewer.PaintProfilerView._logItemCategoriesMap)return LayerViewer.PaintProfilerView._logItemCategoriesMap;const e=LayerViewer.PaintProfilerView.categories();const t={};t["Clear"]=e["misc"];t["DrawPaint"]=e["misc"];t["DrawData"]=e["misc"];t["SetMatrix"]=e["misc"];t["PushCull"]=e["misc"];t["PopCull"]=e["misc"];t["Translate"]=e["misc"];t["Scale"]=e["misc"];t["Concat"]=e["misc"];t["Restore"]=e["misc"];t["SaveLayer"]=e["misc"];t["Save"]=e["misc"];t["BeginCommentGroup"]=e["misc"];t["AddComment"]=e["misc"];t["EndCommentGroup"]=e["misc"];t["ClipRect"]=e["misc"];t["ClipRRect"]=e["misc"];t["ClipPath"]=e["misc"];t["ClipRegion"]=e["misc"];t["DrawPoints"]=e["shapes"];t["DrawRect"]=e["shapes"];t["DrawOval"]=e["shapes"];t["DrawRRect"]=e["shapes"];t["DrawPath"]=e["shapes"];t["DrawVertices"]=e["shapes"];t["DrawDRRect"]=e["shapes"];t["DrawBitmap"]=e["bitmap"];t["DrawBitmapRectToRect"]=e["bitmap"];t["DrawBitmapMatrix"]=e["bitmap"];t["DrawBitmapNine"]=e["bitmap"];t["DrawSprite"]=e["bitmap"];t["DrawPicture"]=e["bitmap"];t["DrawText"]=e["text"];t["DrawPosText"]=e["text"];t["DrawPosTextH"]=e["text"];t["DrawTextOnPath"]=e["text"];LayerViewer.PaintProfilerView._logItemCategoriesMap=t;return t}static _categoryForLogItem(e){const t=e.method.toTitleCase();const i=LayerViewer.PaintProfilerView._initLogItemCategories();let r=i[t];if(!r){r=LayerViewer.PaintProfilerView.categories()["misc"];i[t]=r}return r}onResize(){this._update()}async setSnapshotAndLog(e,t,i){this._reset();this._snapshot=e;if(this._snapshot)this._snapshot.addReference();this._log=t;this._logCategories=this._log.map(LayerViewer.PaintProfilerView._categoryForLogItem);if(!this._snapshot){this._update();this._pieChart.setTotal(0);this._selectionWindow.setEnabled(false);return}this._selectionWindow.setEnabled(true);this._progressBanner.classList.remove("hidden");this._updateImage();const r=await e.profile(i);this._progressBanner.classList.add("hidden");this._profiles=r;this._update();this._updatePieChart()}setScale(e){const t=e>this._scale;const i=2;this._pendingScale=Math.min(1,e*i);if(t&&this._snapshot)this._updateImage()}_update(){this._canvas.width=this._canvasContainer.clientWidth*window.devicePixelRatio;this._canvas.height=this._canvasContainer.clientHeight*window.devicePixelRatio;this._samplesPerBar=0;if(!this._profiles||!this._profiles.length)return;const e=Math.floor((this._canvas.width-2*this._barPaddingWidth)/this._outerBarWidth);const t=this._log.length;this._samplesPerBar=Math.ceil(t/e);let i=0;const r=[];const s=[];let o={};for(let e=0,n=0,a=0;e<t;){let l=this._logCategories[e]&&this._logCategories[e].name||"misc";const h=this._log[e].commandIndex;for(let e=0;e<this._profiles.length;e++){const t=this._profiles[e][h];a+=t;o[l]=(o[l]||0)+t}++e;if(e-n===this._samplesPerBar||e===t){const t=this._profiles.length*(e-n);a/=t;for(l in o)o[l]/=t;r.push(a);s.push(o);if(a>i)i=a;a=0;o={};n=e}}const n=4*window.devicePixelRatio;const a=(this._canvas.height-n-this._minBarHeight)/i;for(let e=0;e<r.length;++e){for(const t in s[e])s[e][t]*=(r[e]*a+this._minBarHeight)/r[e];this._renderBar(e,s[e])}}_renderBar(e,t){const i=LayerViewer.PaintProfilerView.categories();let r=0;const s=this._barPaddingWidth+e*this._outerBarWidth;for(const e in i){if(!t[e])continue;r+=t[e];const o=this._canvas.height-r;this._context.fillStyle=i[e].color;this._context.fillRect(s,o,this._innerBarWidth,t[e])}}_onWindowChanged(){this.dispatchEventToListeners(LayerViewer.PaintProfilerView.Events.WindowChanged);this._updatePieChart();if(this._updateImageTimer)return;this._updateImageTimer=setTimeout(this._updateImage.bind(this),100)}_updatePieChart(){const e=this.selectionWindow();if(!this._profiles||!this._profiles.length||!e)return;let t=0;const i={};for(let r=e.left;r<e.right;++r){const e=this._log[r];const s=LayerViewer.PaintProfilerView._categoryForLogItem(e);i[s.color]=i[s.color]||0;for(let r=0;r<this._profiles.length;++r){const o=this._profiles[r][e.commandIndex];t+=o;i[s.color]+=o}}this._pieChart.setTotal(t/this._profiles.length);for(const e in i)this._pieChart.addSlice(i[e]/this._profiles.length,e)}_formatPieChartTime(e){return Number.millisToString(e*1e3,true)}selectionWindow(){if(!this._log)return null;const e=this._selectionWindow.windowLeft*this._canvas.width;const t=this._selectionWindow.windowRight*this._canvas.width;const i=Math.floor(e/this._outerBarWidth);const r=Math.floor((t+this._innerBarWidth-this._barPaddingWidth/2)/this._outerBarWidth);const s=Number.constrain(i*this._samplesPerBar,0,this._log.length-1);const o=Number.constrain(r*this._samplesPerBar,0,this._log.length);return{left:s,right:o}}_updateImage(){delete this._updateImageTimer;let e;let t;const i=this.selectionWindow();if(this._profiles&&this._profiles.length&&i){e=this._log[i.left].commandIndex;t=this._log[i.right-1].commandIndex}const r=this._pendingScale;this._snapshot.replay(r,e,t).then(e=>{if(!e)return;this._scale=r;this._showImageCallback(e)})}_reset(){if(this._snapshot)this._snapshot.release();this._snapshot=null;this._profiles=null;this._selectionWindow.reset();this._selectionWindow.setEnabled(false)}};LayerViewer.PaintProfilerView.Events={WindowChanged:Symbol("WindowChanged")};LayerViewer.PaintProfilerCommandLogView=class extends UI.ThrottledWidget{constructor(){super();this.setMinimumSize(100,25);this.element.classList.add("overflow-auto");this._treeOutline=new UI.TreeOutlineInShadow;this.element.appendChild(this._treeOutline.element);this._log=[]}setCommandLog(e){this._log=e;this._treeItemCache=new Map;this.updateWindow({left:0,right:this._log.length})}_appendLogItem(e){let t=this._treeItemCache.get(e);if(!t){t=new LayerViewer.LogTreeElement(this,e);this._treeItemCache.set(e,t)}else if(t.parent){return}this._treeOutline.appendChild(t)}updateWindow(e){this._selectionWindow=e;this.update()}doUpdate(){if(!this._selectionWindow||!this._log.length){this._treeOutline.removeChildren();return Promise.resolve()}const e=this._treeOutline.rootElement();for(;;){const t=e.firstChild();if(!t||t._logItem.commandIndex>=this._selectionWindow.left)break;e.removeChildAtIndex(0)}for(;;){const t=e.lastChild();if(!t||t._logItem.commandIndex<this._selectionWindow.right)break;e.removeChildAtIndex(e.children().length-1)}for(let e=this._selectionWindow.left,t=this._selectionWindow.right;e<t;++e)this._appendLogItem(this._log[e]);return Promise.resolve()}};LayerViewer.LogTreeElement=class extends UI.TreeElement{constructor(e,t){super("",!!t.params);this._logItem=t;this._ownerView=e;this._filled=false}onattach(){this._update()}async onpopulate(){for(const e in this._logItem.params)LayerViewer.LogPropertyTreeElement._appendLogPropertyItem(this,e,this._logItem.params[e])}_paramToString(e,t){if(typeof e!=="object")return typeof e==="string"&&e.length>100?t:JSON.stringify(e);let i="";let r=0;for(const s in e){if(++r>4||typeof e[s]==="object"||typeof e[s]==="string"&&e[s].length>100)return t;if(i)i+=", ";i+=e[s]}return i}_paramsToString(e){let t="";for(const i in e){if(t)t+=", ";t+=this._paramToString(e[i],i)}return t}_update(){const e=createDocumentFragment();e.createTextChild(this._logItem.method+"("+this._paramsToString(this._logItem.params)+")");this.title=e}};LayerViewer.LogPropertyTreeElement=class extends UI.TreeElement{constructor(e){super();this._property=e}static _appendLogPropertyItem(e,t,i){const r=new LayerViewer.LogPropertyTreeElement({name:t,value:i});e.appendChild(r);if(i&&typeof i==="object"){for(const e in i)LayerViewer.LogPropertyTreeElement._appendLogPropertyItem(r,e,i[e])}}onattach(){const e=createDocumentFragment();const t=e.createChild("span","name");t.textContent=this._property.name;const i=e.createChild("span","separator");i.textContent=": ";if(this._property.value===null||typeof this._property.value!=="object"){const t=e.createChild("span","value");t.textContent=JSON.stringify(this._property.value);t.classList.add("cm-js-"+(this._property.value===null?"null":typeof this._property.value))}this.title=e}};LayerViewer.PaintProfilerCategory=class{constructor(e,t,i){this.name=e;this.title=t;this.color=i}};LayerViewer.TransformController=class extends Common.Object{constructor(e,t){super();this._shortcuts={};this.element=e;if(this.element.tabIndex<0)this.element.tabIndex=0;this._registerShortcuts();UI.installDragHandle(e,this._onDragStart.bind(this),this._onDrag.bind(this),this._onDragEnd.bind(this),"move",null);e.addEventListener("keydown",this._onKeyDown.bind(this),false);e.addEventListener("keyup",this._onKeyUp.bind(this),false);e.addEventListener("mousewheel",this._onMouseWheel.bind(this),false);this._minScale=0;this._maxScale=Infinity;this._controlPanelToolbar=new UI.Toolbar("transform-control-panel");this._modeButtons={};if(!t){const e=new UI.ToolbarToggle(Common.UIString("Pan mode (X)"),"largeicon-pan");e.addEventListener(UI.ToolbarButton.Events.Click,this._setMode.bind(this,LayerViewer.TransformController.Modes.Pan));this._modeButtons[LayerViewer.TransformController.Modes.Pan]=e;this._controlPanelToolbar.appendToolbarItem(e);const t=new UI.ToolbarToggle(Common.UIString("Rotate mode (V)"),"largeicon-rotate");t.addEventListener(UI.ToolbarButton.Events.Click,this._setMode.bind(this,LayerViewer.TransformController.Modes.Rotate));this._modeButtons[LayerViewer.TransformController.Modes.Rotate]=t;this._controlPanelToolbar.appendToolbarItem(t)}this._setMode(LayerViewer.TransformController.Modes.Pan);const i=new UI.ToolbarButton(Common.UIString("Reset transform (0)"),"largeicon-center");i.addEventListener(UI.ToolbarButton.Events.Click,this.resetAndNotify.bind(this,undefined));this._controlPanelToolbar.appendToolbarItem(i);this._reset()}toolbar(){return this._controlPanelToolbar}_onKeyDown(e){if(e.keyCode===UI.KeyboardShortcut.Keys.Shift.code){this._toggleMode();return}const t=UI.KeyboardShortcut.makeKeyFromEventIgnoringModifiers(e);const i=this._shortcuts[t];if(i&&i(e))e.consume()}_onKeyUp(e){if(e.keyCode===UI.KeyboardShortcut.Keys.Shift.code)this._toggleMode()}_addShortcuts(e,t){for(let i=0;i<e.length;++i)this._shortcuts[e[i].key]=t}_registerShortcuts(){this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.ResetView,this.resetAndNotify.bind(this));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.PanMode,this._setMode.bind(this,LayerViewer.TransformController.Modes.Pan));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.RotateMode,this._setMode.bind(this,LayerViewer.TransformController.Modes.Rotate));const e=1.1;this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.ZoomIn,this._onKeyboardZoom.bind(this,e));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.ZoomOut,this._onKeyboardZoom.bind(this,1/e));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.Up,this._onKeyboardPanOrRotate.bind(this,0,-1));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.Down,this._onKeyboardPanOrRotate.bind(this,0,1));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.Left,this._onKeyboardPanOrRotate.bind(this,-1,0));this._addShortcuts(UI.ShortcutsScreen.LayersPanelShortcuts.Right,this._onKeyboardPanOrRotate.bind(this,1,0))}_postChangeEvent(){this.dispatchEventToListeners(LayerViewer.TransformController.Events.TransformChanged)}_reset(){this._scale=1;this._offsetX=0;this._offsetY=0;this._rotateX=0;this._rotateY=0}_toggleMode(){this._setMode(this._mode===LayerViewer.TransformController.Modes.Pan?LayerViewer.TransformController.Modes.Rotate:LayerViewer.TransformController.Modes.Pan)}_setMode(e){if(this._mode===e)return;this._mode=e;this._updateModeButtons();this.element.focus()}_updateModeButtons(){for(const e in this._modeButtons)this._modeButtons[e].setToggled(e===this._mode)}resetAndNotify(e){this._reset();this._postChangeEvent();if(e)e.preventDefault();this.element.focus()}setScaleConstraints(e,t){this._minScale=e;this._maxScale=t;this._scale=Number.constrain(this._scale,e,t)}clampOffsets(e,t,i,r){this._offsetX=Number.constrain(this._offsetX,e,t);this._offsetY=Number.constrain(this._offsetY,i,r)}scale(){return this._scale}offsetX(){return this._offsetX}offsetY(){return this._offsetY}rotateX(){return this._rotateX}rotateY(){return this._rotateY}_onScale(e,t,i){e=Number.constrain(this._scale*e,this._minScale,this._maxScale)/this._scale;this._scale*=e;this._offsetX-=(t-this._offsetX)*(e-1);this._offsetY-=(i-this._offsetY)*(e-1);this._postChangeEvent()}_onPan(e,t){this._offsetX+=e;this._offsetY+=t;this._postChangeEvent()}_onRotate(e,t){this._rotateX=e;this._rotateY=t;this._postChangeEvent()}_onKeyboardZoom(e){this._onScale(e,this.element.clientWidth/2,this.element.clientHeight/2)}_onKeyboardPanOrRotate(e,t){const i=6;const r=5;if(this._mode===LayerViewer.TransformController.Modes.Rotate){this._onRotate(this._rotateX+t*r,this._rotateY+e*r)}else{this._onPan(e*i,t*i)}}_onMouseWheel(e){const t=1.1;const i=1/120;const r=Math.pow(t,e.wheelDeltaY*i);this._onScale(r,e.clientX-this.element.totalOffsetLeft(),e.clientY-this.element.totalOffsetTop())}_onDrag(e){if(this._mode===LayerViewer.TransformController.Modes.Rotate){this._onRotate(this._oldRotateX+(this._originY-e.clientY)/this.element.clientHeight*180,this._oldRotateY-(this._originX-e.clientX)/this.element.clientWidth*180)}else{this._onPan(e.clientX-this._originX,e.clientY-this._originY);this._originX=e.clientX;this._originY=e.clientY}}_onDragStart(e){this.element.focus();this._originX=e.clientX;this._originY=e.clientY;this._oldRotateX=this._rotateX;this._oldRotateY=this._rotateY;return true}_onDragEnd(){delete this._originX;delete this._originY;delete this._oldRotateX;delete this._oldRotateY}};LayerViewer.TransformController.Events={TransformChanged:Symbol("TransformChanged")};LayerViewer.TransformController.Modes={Pan:"Pan",Rotate:"Rotate"};Runtime.cachedResources["layer_viewer/layers3DView.css"]="/*\n * Copyright 2016 The Chromium Authors. All rights reserved.\n * Use of this source code is governed by a BSD-style license that can be\n * found in the LICENSE file.\n */\n\n.layers-3d-view {\n    overflow: hidden;\n    -webkit-user-select: none;\n}\n\n.toolbar {\n    background-color: var(--toolbar-bg-color);\n    border-bottom: var(--divider-border);\n}\n\ncanvas {\n    flex: 1 1;\n}\n";Runtime.cachedResources["layer_viewer/paintProfiler.css"]="/*\n * Copyright 2016 The Chromium Authors. All rights reserved.\n * Use of this source code is governed by a BSD-style license that can be\n * found in the LICENSE file.\n */\n\n.paint-profiler-overview {\n    background-color: #eee;\n}\n\n.paint-profiler-canvas-container {\n    flex: auto;\n    position: relative;\n}\n\n.paint-profiler-pie-chart {\n    width: 60px !important;\n    height: 60px !important;\n    padding: 2px;\n    overflow: hidden;\n    font-size: 10px;\n}\n\n.paint-profiler-canvas-container canvas {\n    z-index: 200;\n    background-color: white;\n    opacity: 0.95;\n    height: 100%;\n    width: 100%;\n}\n\n.paint-profiler-canvas-container .overview-grid-window-resizer {\n    z-index: 2000;\n}\n";Runtime.cachedResources["layer_viewer/layerDetailsView.css"]="/*\n * Copyright 2016 The Chromium Authors. All rights reserved.\n * Use of this source code is governed by a BSD-style license that can be\n * found in the LICENSE file.\n */\n\ntable td {\n    padding-left: 8px;\n}\n\ntable td:first-child {\n    font-weight: bold;\n}\n\n.scroll-rect.active {\n    background-color: rgba(100, 100, 100, 0.2);\n}\n\nul {\n    list-style: none;\n    padding-inline-start: 0;\n    margin-block-start: 0;\n    margin-block-end: 0;\n}\n\na {\n    padding: 8px;\n    display: block;\n}\n";