self["WorkspaceDiff"]=self["WorkspaceDiff"]||{};WorkspaceDiff.WorkspaceDiff=class extends Common.Object{constructor(e){super();this._uiSourceCodeDiffs=new WeakMap;this._loadingUISourceCodes=new Map;this._modifiedUISourceCodes=new Set;e.addEventListener(Workspace.Workspace.Events.WorkingCopyChanged,this._uiSourceCodeChanged,this);e.addEventListener(Workspace.Workspace.Events.WorkingCopyCommitted,this._uiSourceCodeChanged,this);e.addEventListener(Workspace.Workspace.Events.UISourceCodeAdded,this._uiSourceCodeAdded,this);e.addEventListener(Workspace.Workspace.Events.UISourceCodeRemoved,this._uiSourceCodeRemoved,this);e.addEventListener(Workspace.Workspace.Events.ProjectRemoved,this._projectRemoved,this);e.uiSourceCodes().forEach(this._updateModifiedState.bind(this))}requestDiff(e){return this._uiSourceCodeDiff(e).requestDiff()}subscribeToDiffChange(e,i,o){this._uiSourceCodeDiff(e).addEventListener(WorkspaceDiff.Events.DiffChanged,i,o)}unsubscribeFromDiffChange(e,i,o){this._uiSourceCodeDiff(e).removeEventListener(WorkspaceDiff.Events.DiffChanged,i,o)}modifiedUISourceCodes(){return Array.from(this._modifiedUISourceCodes)}isUISourceCodeModified(e){return this._modifiedUISourceCodes.has(e)||this._loadingUISourceCodes.has(e)}_uiSourceCodeDiff(e){if(!this._uiSourceCodeDiffs.has(e))this._uiSourceCodeDiffs.set(e,new WorkspaceDiff.WorkspaceDiff.UISourceCodeDiff(e));return this._uiSourceCodeDiffs.get(e)}_uiSourceCodeChanged(e){const i=e.data.uiSourceCode;this._updateModifiedState(i)}_uiSourceCodeAdded(e){const i=e.data;this._updateModifiedState(i)}_uiSourceCodeRemoved(e){const i=e.data;this._removeUISourceCode(i)}_projectRemoved(e){const i=e.data;for(const e of i.uiSourceCodes())this._removeUISourceCode(e)}_removeUISourceCode(e){this._loadingUISourceCodes.delete(e);const i=this._uiSourceCodeDiffs.get(e);if(i)i._dispose=true;this._markAsUnmodified(e)}_markAsUnmodified(e){this._uiSourceCodeProcessedForTest();if(this._modifiedUISourceCodes.delete(e))this.dispatchEventToListeners(WorkspaceDiff.Events.ModifiedStatusChanged,{uiSourceCode:e,isModified:false})}_markAsModified(e){this._uiSourceCodeProcessedForTest();if(this._modifiedUISourceCodes.has(e))return;this._modifiedUISourceCodes.add(e);this.dispatchEventToListeners(WorkspaceDiff.Events.ModifiedStatusChanged,{uiSourceCode:e,isModified:true})}_uiSourceCodeProcessedForTest(){}async _updateModifiedState(e){this._loadingUISourceCodes.delete(e);if(e.project().type()!==Workspace.projectTypes.Network){this._markAsUnmodified(e);return}if(e.isDirty()){this._markAsModified(e);return}if(!e.hasCommits()){this._markAsUnmodified(e);return}const i=Promise.all([this.requestOriginalContentForUISourceCode(e),e.requestContent()]);this._loadingUISourceCodes.set(e,i);const o=await i;if(this._loadingUISourceCodes.get(e)!==i)return;this._loadingUISourceCodes.delete(e);if(o[0]!==null&&o[1]!==null&&o[0]!==o[1])this._markAsModified(e);else this._markAsUnmodified(e)}requestOriginalContentForUISourceCode(e){return this._uiSourceCodeDiff(e)._originalContent()}revertToOriginal(e){function i(i){if(typeof i!=="string")return;e.addRevision(i)}Host.userMetrics.actionTaken(Host.UserMetrics.Action.RevisionApplied);return this.requestOriginalContentForUISourceCode(e).then(i)}};WorkspaceDiff.WorkspaceDiff.UISourceCodeDiff=class extends Common.Object{constructor(e){super();this._uiSourceCode=e;e.addEventListener(Workspace.UISourceCode.Events.WorkingCopyChanged,this._uiSourceCodeChanged,this);e.addEventListener(Workspace.UISourceCode.Events.WorkingCopyCommitted,this._uiSourceCodeChanged,this);this._requestDiffPromise=null;this._pendingChanges=null;this._dispose=false}_uiSourceCodeChanged(){if(this._pendingChanges){clearTimeout(this._pendingChanges);this._pendingChanges=null}this._requestDiffPromise=null;const e=this._uiSourceCode.content();const i=!e||e.length<65536?0:WorkspaceDiff.WorkspaceDiff.UpdateTimeout;this._pendingChanges=setTimeout(o.bind(this),i);function o(){if(this._dispose)return;this.dispatchEventToListeners(WorkspaceDiff.Events.DiffChanged);this._pendingChanges=null}}requestDiff(){if(!this._requestDiffPromise)this._requestDiffPromise=this._innerRequestDiff();return this._requestDiffPromise}_originalContent(){const e=Persistence.networkPersistenceManager.originalContentForUISourceCode(this._uiSourceCode);if(e)return e;let i;const o=new Promise(e=>i=e);this._uiSourceCode.project().requestFileContent(this._uiSourceCode,i);return o}async _innerRequestDiff(){if(this._dispose)return null;const e=await this._originalContent();if(e.length>1024*1024)return null;if(this._dispose)return null;let i=this._uiSourceCode.workingCopy();if(!i&&!this._uiSourceCode.contentLoaded())i=await this._uiSourceCode.requestContent();if(i.length>1024*1024)return null;if(this._dispose)return null;if(i===null||e===null)return null;return Diff.Diff.lineDiff(e.split(/\r\n|\n|\r/),i.split(/\r\n|\n|\r/))}};WorkspaceDiff.Events={DiffChanged:Symbol("DiffChanged"),ModifiedStatusChanged:Symbol("ModifiedStatusChanged")};WorkspaceDiff.workspaceDiff=function(){if(!WorkspaceDiff.WorkspaceDiff._instance)WorkspaceDiff.WorkspaceDiff._instance=new WorkspaceDiff.WorkspaceDiff(Workspace.workspace);return WorkspaceDiff.WorkspaceDiff._instance};WorkspaceDiff.DiffUILocation=class{constructor(e){this.uiSourceCode=e}};WorkspaceDiff.WorkspaceDiff.UpdateTimeout=200;